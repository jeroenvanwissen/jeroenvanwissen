import fs from "node:fs";
import path from "node:path";
import matter from "gray-matter";

interface Post {
  title: string;
  date: string;
  description: string;
  slug: string;
  filename: string;
}

interface SocialLink {
  alt: string;
  url: string;
  label?: string;
  logo?: string;
  logoColor?: string;
  color: string;
}

const SOCIAL_LINKS: SocialLink[] = [
  {
    alt: "Bluesky",
    url: "https://bsky.app/profile/jeroenvanwissen.nl",
    label: "Bluesky",
    logo: "bluesky",
    logoColor: "white",
    color: "0085ff",
  },
  {
    alt: "Mastodon",
    url: "https://mastodon.social/@jeroenvanwissen",
    label: "Mastodon",
    logo: "mastodon",
    logoColor: "white",
    color: "6364ff",
  },
  {
    alt: "X",
    url: "https://twitter.com/jvwissen",
    logo: "x",
    logoColor: "white",
    color: "000000",
  },
  {
    alt: "LinkedIn",
    url: "https://www.linkedin.com/in/jeroenvanwissen/",
    label: "LinkedIn",
    logo: "linkedin",
    logoColor: "white",
    color: "0a66c2",
  },
  {
    alt: "Jeroen van Wissen",
    url: "https://jeroenvanwissen.nl",
    label: "jeroenvanwissen.nl",
    logoColor: "white",
    color: "ff2bb9",
  },
  {
    alt: "31F-Fotografie",
    url: "https://31f-fotografie.nl",
    label: "31f--fotografie.nl",
    logoColor: "white",
    color: "333",
  },
];

function buildBadgeUrl(link: SocialLink): string {
  const parts: string[] = [];
  parts.push(`style=for-the-badge`);
  if (link.logo) parts.push(`logo=${link.logo}`);
  if (link.logoColor) parts.push(`logoColor=${link.logoColor}`);
  const label = link.label ?? "";
  return `https://img.shields.io/badge/${label}-${link.color}?${parts.join("&")}`;
}

export function generateReadme(): string {
  const posts = loadPosts();

  const postsSection =
    posts.length > 0
      ? `## Latest Posts

${posts
  .slice(0, 5)
  .map(
    (post) =>
      `- [**${post.title}**](posts/${post.filename}) â€” <sub>${formatDate(post.date)}</sub>  \n  <sub>${post.description}</sub>`,
  )
  .join("\n")}

${posts.length > 5 ? `\n<sub>[View all posts...](posts/)</sub>\n` : ""}`
      : "";

  const socialSection = SOCIAL_LINKS.map((link) => {
    const badgeUrl = buildBadgeUrl(link);
    return `<a href="${link.url}"><img src="${badgeUrl}" alt="${link.alt}" /></a>`;
  }).join("\n  ");

  return `<p align="center">
  <img src="generated/header.svg" alt="Jeroen van Wissen" width="840" />
</p>

<br />

<p align="center">
  <em>
    Full-stack JavaScript/TypeScript developer from the Netherlands with 27+ years in tech.<br />
    Building with React, Vue, Node.js and NestJS.<br />
    Brewing beer, shooting photos, and figuring out life along the way.
  </em>
</p>

<br />

<p align="center">
  <img src="generated/languages.svg" alt="Top Languages" width="420" />
  <img src="generated/stats.svg" alt="GitHub Stats" width="420" />
</p>

<br />

${postsSection}
${postsSection ? "\n<br />\n\n" : ""}---

<p align="center">
  ${socialSection}
</p>

<p align="center">
  <sub>This README is auto-generated by a <a href=".github/workflows/generate-readme.yml">GitHub Action</a></sub>
</p>
`;
}

function loadPosts(): Post[] {
  const postsDir = path.resolve(process.cwd(), "posts");

  if (!fs.existsSync(postsDir)) {
    return [];
  }

  const files = fs.readdirSync(postsDir).filter((f) => f.endsWith(".md"));

  const posts: Post[] = files
    .map((filename) => {
      const content = fs.readFileSync(path.join(postsDir, filename), "utf-8");
      const { data } = matter(content);

      if (!data.title || !data.date) {
        return null;
      }

      return {
        title: data.title,
        date: String(data.date),
        description: data.description || "",
        slug: filename.replace(/\.md$/, ""),
        filename,
      };
    })
    .filter((p): p is Post => p !== null);

  // Sort by date descending (newest first)
  posts.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

  return posts;
}

function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  return date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}
